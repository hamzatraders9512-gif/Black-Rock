<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Black Rock — Reset Password</title>
  <link rel="stylesheet" href="css/styles-new.css">
</head>
<body>
  <main class="terminal">
    <div class="terminal-window">
      <div class="brand">
        <div class="logo">
          <div class="logo-icon">◉</div>
          <div class="logo-text">
            <span class="green">Black</span><span class="orange">Rock</span>
          </div>
        </div>
      </div>

      <h1 class="welcome">Choose a new password</h1>

      <div class="auth-section">
        <form class="form" id="resetForm" novalidate>
          <input type="hidden" id="tokenField">
          <input type="hidden" id="emailField">

          <div class="input-group">
            <div class="label-row">
              <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M12 15v2m-6 4h12a2 2 0 002-2v-8a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8V7z" stroke="currentColor" stroke-width="2"/>
              </svg>
              <span class="input-label">New Password</span>
            </div>
            <div class="password-field">
              <input type="password" name="password" id="newPassword" class="input-field" placeholder="New password" required>
              <button type="button" class="eye-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" stroke-width="2"/>
                  <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="input-group">
            <div class="label-row">
              <span class="input-label">Confirm Password</span>
            </div>
            <input type="password" id="confirmPassword" class="input-field" placeholder="Confirm new password" required>
          </div>

          <button type="submit" class="continue-btn">Set new password</button>
        </form>
      </div>

      <footer>
        <p class="signup-text">
          Back to <a href="index.html" class="signup-link">Sign in</a>
        </p>
      </footer>
    </div>
  </main>

  <script src="js/auth-shared.js"></script>
  <script>
    // Parse query params for token and email
    function getQueryParams() {
      const params = {};
      location.search.replace(/^[?#]/, '').split('&').forEach(pair => {
        if (!pair) return;
        const parts = pair.split('=');
        params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
      });
      return params;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const params = getQueryParams();
      const tokenField = document.getElementById('tokenField');
      const emailField = document.getElementById('emailField');
      if (params.token) tokenField.value = params.token;
      if (params.email) emailField.value = params.email;

      // initialize password toggle
      if (typeof initializePasswordToggles === 'function') {
        initializePasswordToggles();
      }
      // attach password strength UI
      const newPasswordInput = document.getElementById('newPassword');
      attachPasswordStrength(newPasswordInput);

      const form = document.getElementById('resetForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = tokenField.value;
        const email = emailField.value;
        const pw = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;

        if (!pw || pw.length < 8) {
          showToast('Password must be at least 8 characters', 'error');
          return;
        }
        if (pw !== confirm) {
          showToast('Passwords do not match', 'error');
          return;
        }

        try {
          const res = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, token, newPassword: pw })
          });
          const data = await res.json();
          if (res.ok) {
            showToast(data.message || 'Password reset successful', 'success');
            setTimeout(() => window.location.href = '/index.html', 2000);
          } else {
            showToast(data.message || 'Unable to reset password', 'error');
          }
        } catch (err) {
          console.error(err);
          showToast('Connection error. Try again later.', 'error');
        }
      });
    });
  </script>
</body>
</html>